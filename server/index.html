<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiment Controller</title>
    <script src="{{ url_for('static', filename='socketio.min.js') }}"></script>
    <script src="{{ url_for('static', filename='plotly.min.js') }}"></script>
</head>
<body>
  <h1>Experiment Controller</h1>
  <img src="/screen" width="640">
  <h2>Controls</h2>
  <button onclick="sendCommand('goodmonkey')">Good Monkey!</button>
  <button onclick="sendCommand('quit')">Stop Task</button>

  <div id="info">
    <h2>Current Trial Info</h2>
    <p><b>Trial ID:</b> <span id="trialid"></span></p>
    <p><b>Condition:</b> <span id="condition"></span></p>
    <p><b>Block:</b> <span id="block"></span></p>
    <p><b>Block Number:</b> <span id="block_number"></span></p>
  </div>

  <div id="summary">
    <h2>Block Summary</h2>
    <table id="summary-table">
      <thead>
        <tr>
          <th>Block Number</th>
          <th>Block</th>
          <th>Outcome: Correct</th>
          <th>Outcome: Error</th>
          <th>Outcome: Timeout</th>
          <th>Optimal: True</th>
          <th>Optimal: False</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>


  <p id="response"></p>
</body>
<script src="{{ url_for('static', filename='main.js') }}"></script>
<script>
    
    function updateDisplay(data) {
      if (!data || Object.keys(data).length === 0) return;
      // --- Get the latest trial ---
      const lastKey = Math.max(...Object.keys(data).map(k => parseInt(k)));
      const lastTrial = data[lastKey];
      document.getElementById('trialid').textContent = lastTrial.trialid ?? 'N/A';
      document.getElementById('condition').textContent = lastTrial.condition ?? 'N/A';
      document.getElementById('block').textContent = lastTrial.block ?? 'N/A';
      document.getElementById('block_number').textContent = lastTrial.block_number ?? 'N/A';
      // --- Aggregate counts per block ---
      const summary = {};
      for (const key in data) {
        const trial = data[key];
        const b = trial.block_number;
        if (!summary[b]) {
          summary[b] = { block: trial.block, correct: 0, error: 0, timeout: 0 };
        }
        if (trial.outcome) {
          if (trial.outcome === 'correct') summary[b].correct++;
          else if (trial.outcome === 'error') summary[b].error++;
          else if (trial.outcome === 'timeout') summary[b].timeout++;
        }
      }
      // --- Update table ---
      const tbody = document.querySelector('#summary-table tbody');
      tbody.innerHTML = '';
      for (const b in summary) {
        const s = summary[b];
        const row = `<tr>
          <td>${b}</td>
          <td>${s.block}</td>
          <td>${s.correct}</td>
          <td>${s.error}</td>
          <td>${s.timeout}</td>
        </tr>`;
        tbody.innerHTML += row;
      }
      tbody.innerHTML += `<tr>
        <td colspan="2"><b>Total</b></td>
        <td><b>${Object.values(summary).reduce((a,b) => a + b.correct, 0)}</b></td>
        <td><b>${Object.values(summary).reduce((a,b) => a + b.error, 0)}</b></td>
        <td><b>${Object.values(summary).reduce((a,b) => a + b.timeout, 0)}</b></td>
      </tr>`;
      updatePlot(data);
    }

    function fetchBehaviour() {
        fetch('/behaviour_summary')
        .then(response=>response.json())
        .then(data => {
            updateDisplay(data)
        })
    }
</script>
</html>